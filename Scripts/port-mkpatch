#!/bin/sh -e

##########################################################################
#   Synopsis:
#       port-mkpatch work/path/to/file
#       
#   Description:
#       .B port-mkpatch
#       Generates a proper FreeBSD ports patch in portname/files
#       by diffing work/path/to/file.orig and work/path/to/file.
#       It should not be necessary to run "make makepatch" to
#       fomat the patch file generated by port-mkpatch.  It should
#       already be compatible.
#
#       .B port-mkpatch
#       is not usually run directly, but via port-patch-edit(1).
#       
#   Arguments:
#       work/path/to/file   Path to patched file relative to port directory
#       
#   Returns:
#       0 on success, non-zero error codes otherwise
#
#   Examples:
#       port-mkpatch work/fasda-0.2.0/fold-change.c
#
#   See also:
#       port-check(1), port-create(1), port-diff(1), port-patch-edit(1),
#       port-remake(1), port-reinstall(1), port-restage(1)
#
#   History:
#   Date        Name        Modification
#   2014-11-10  J Bacon     Begin
##########################################################################

usage()
{
    printf "Usage: $0 filename\n"
    exit 1
}


##########################################################################
#   Main
##########################################################################

if [ $# != 1 ]; then
    usage
fi

filename="$1"

if [ ! -e pkg-descr ]; then
    printf "$0 must be run from the port directory.\n"
    exit 1
fi

if [ ! -e "$filename.orig" ]; then
    printf "Error: No $filename.orig present.\n"
    exit 1
fi

# Determine WRKSRC
port_dir=`pwd`
# If WRKSRC is not set, assume first two components of pathname
grandparent=${port_dir%/*/*}
port=${port_dir#$grandparent/}
WRKSRC=`auto-print-make-variable --base-dir $grandparent $port WRKSRC`
# Get relative path
WRKSRC=${WRKSRC#$port_dir/}

mkdir -p files

# Go to WRKSRC and generate patch file
cd $WRKSRC
file1=${filename#./$WRKSRC/}
file=${file1#$WRKSRC/}
patch_file='patch-'`echo "$file" | sed -e 's|_|__|g' | sed -e 's|/|_|g'`
printf "Writing files/$patch_file.\n"
# Match diff command to Mk/Scripts/smart_makepatch.sh
# to avoid need to run make makepatch
TZ=UTC diff -udp "$file.orig" "$file" | sed \
			-e '/^---/s|\.[0-9]* +0000$| UTC|' \
			-e '/^+++/s|\([[:blank:]][-0-9:.+]*\)*$||' \
			> $port_dir/files/$patch_file || true
cd $port_dir
